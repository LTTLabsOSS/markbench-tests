name: Sync Branch Folders

on:
  workflow_dispatch:

jobs:
  sync:
    runs-on: [self-hosted, Windows]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sync branches to folders
        shell: bash
        run: |
          set -euo pipefail

          # Base folder from secret
          BASE_DIR="${{ secrets.NETWORK_DRIVE_PATH }}\03_ProcessingFiles\markbench_harnesses"
          mkdir -p "$BASE_DIR"
          echo "Using BASE_DIR=$BASE_DIR"

          # Convert Windows-style paths to bash style if needed
          BASE_DIR=$(realpath "$BASE_DIR")

          # Make sure all remote branches are fetched
          git fetch --all --prune

          # List all remote branches, ignore HEAD
          branches=$(git for-each-ref --format='%(refname:short)' refs/remotes/origin/ | sed 's|origin/||' | grep -v HEAD)

          for branch in $branches; do
            # Sanitize branch name for Windows folder
            SAFE_BRANCH=$(echo "$branch" | sed 's/[^a-zA-Z0-9._-]/_/g')
            BRANCH_DIR="$BASE_DIR/$SAFE_BRANCH"

            echo "Processing branch '$branch' -> folder '$BRANCH_DIR'"

            if [ -d "$BRANCH_DIR/.git" ]; then
              # Update existing folder
              cd "$BRANCH_DIR"
              git fetch origin
              git reset --hard "origin/$branch"
              git clean -fdx
              cd -
            else
              # Clone current repo into folder
              git clone --branch "$branch" --single-branch "$(pwd)" "$BRANCH_DIR"
            fi
          done
